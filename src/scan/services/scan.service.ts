import { Injectable, HttpService } from '@nestjs/common';
import { firstValueFrom } from 'rxjs';

const SCAN_URL = 'https://api.rig.cytix.io/api/scan';

@Injectable()
export class ScanService {
  constructor(private readonly httpService: HttpService) {}

  async scan(token: string): Promise<{ id: string }> {
    const url = SCAN_URL;
    const data = {};
    const headers = {
      Authorization: token,
    };

    try {
      const response$ = this.httpService.post(url, data, { headers });
      const response = await firstValueFrom(response$);
      const { scanId } = response.data;
      return { id: scanId };
    } catch (error) {
      console.error('Error getting scan id:', error.message);
      throw error;
    }
  }

  async getScanById(id: string, token: string) {
    const url = `${SCAN_URL}s/${id}/results`;
    const headers = {
      Authorization: token,
    };

    try {
      const response$ = this.httpService.get(url, { headers });
      const response = await firstValueFrom(response$);
      return response.data;
    } catch (error) {
      console.error('Error getting scan by ID:', error.message);
      throw error;
    }
  }
}
